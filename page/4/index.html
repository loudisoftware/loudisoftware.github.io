<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico.svg">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico.svg">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"hide","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="学而不思则罔思而不学则殆">
<meta property="og:type" content="website">
<meta property="og:title" content="WJAINNG">
<meta property="og:url" content="http://example.com/page/4/index.html">
<meta property="og:site_name" content="WJAINNG">
<meta property="og:description" content="学而不思则罔思而不学则殆">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="wjainng">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/4/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>WJAINNG</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">WJAINNG</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2018/08/05/2018-08-05-%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B4%A2%E5%BC%95%E7%90%86%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/mountain.jpg">
      <meta itemprop="name" content="wjainng">
      <meta itemprop="description" content="学而不思则罔思而不学则殆">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WJAINNG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/08/05/2018-08-05-%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B4%A2%E5%BC%95%E7%90%86%E8%A7%A3/" class="post-title-link" itemprop="url">数据库索引理解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-08-05 21:31:38" itemprop="dateCreated datePublished" datetime="2018-08-05T21:31:38+08:00">2018-08-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-16 23:15:44" itemprop="dateModified" datetime="2020-09-16T23:15:44+08:00">2020-09-16</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><ol>
<li>块/页:不管是索引还是表都是按页的方式存储,一般一页的大小为4KB或者8KB,不同的RDBMS会有不同的设置.</li>
<li>索引行大小:因为一个页的大小为4K为了在一页中存储更多的索引条数,并且一个索引行必须能在一个页中存储,不能跨页,并且为了节省空间和更好的存储索引的个数,一般都会对索引的行大小有限制.(如果索引行大小为1K则一个页只能存储一行索引,导致浪费空间和索引页的大小变大)</li>
<li>表行大小:一般情况下表的一行数据不跨页存储,减少IO.对BLOB等大字段需要单独存储.</li>
</ol>
<h2 id="SQL处理过程"><a href="#SQL处理过程" class="headerlink" title="SQL处理过程"></a>SQL处理过程</h2><ol>
<li>谓词<br> where子句由一个或者多个谓词(搜索参数)组成.谓词表达式是索引设计的主要入手点.如果索引能够满足所有谓词表达式,优化器可能建立一个高效的访问路径.</li>
<li>优化器及访问路径<br> SQL语句被真正执行之前,优化器必须首先确定如何访问数据.包括:应该使用哪一个索引,索引的访问方式等.</li>
<li>索引片及匹配列<br> 访问路径的成本很大程度上取决于索引片的厚度(谓词表达式确定的值域范围),索引片越厚需要顺序扫描的索引页就越多,需要处理的索引记录也就越多,同时还有因此而增加的对表的同步读操作.</li>
<li>索引过滤及过滤列<br> 索引列不一定会参与索引片的定义,但这些列仍然能够减少回表进行同步读的次数,这些列成为过滤列.(需要注意索引的顺序)<br> 基本规则如下:<br> 1.1 where子句中如果存在一个简单的谓词例如相等.如果有则该列为匹配列,如果没有则后面的索引列都是非匹配列.<br> 1.2 如果谓词为一个范围谓词,那么剩余的索引都是非匹配列.<br> 1.3 最后一个匹配列之后的索引列如果有足够简单的谓词与其对应则为过滤列.</li>
<li>过滤因子<br> 描述了谓词的选择性,满足谓词的记录行数占记录行的比例,依赖于列值的分布情况.(组合谓词的过滤因子可以认为是各自过滤因子的相乘)</li>
</ol>
<h2 id="合适的索引"><a href="#合适的索引" class="headerlink" title="合适的索引"></a>合适的索引</h2><blockquote>
<p>假设:<br>随机读:10ms,顺序读:0.01ms,FETCH:0.1ms</p>
</blockquote>
<h3 id="三星索引"><a href="#三星索引" class="headerlink" title="三星索引"></a>三星索引</h3><ol>
<li>如果与一个查询相关的索引行是相邻的,或者相距足够近的可以标记为第一颗星.最小化了必须扫描的索引片的宽度.</li>
<li>如果索引行的顺序与查询语句的需求一致,可以标记为第二颗星.避免了排序.</li>
<li>如果索引行包含查询语句中的所有列,可以标记为第三颗星.避免了表的访问,仅访问索引即可.</li>
</ol>
<blockquote>
<p>宽索引:是指一个至少满足第三颗星的索引.该索引包含了select语句所涉及的所有列,使得查询只需访问索引而无须访问表.</p>
</blockquote>
<p><strong>有时并不能总满足三星索引的要求,例如同时存在范围查找和排序时,会造成第一颗星和第二颗星的冲突,这时需要进行权衡,选择第二颗星避免排序,选择第一颗星拥有最窄的索引片.(一般排序的速度比较快,可以只在只需要返回少数数据时选择第二颗星)</strong></p>
<p><em>另外建立组合索引时如果顺序不重要可以把变化大的字段放在索引的最后一列,减少索引维护时页的分裂</em></p>
<h2 id="索引设计的依据"><a href="#索引设计的依据" class="headerlink" title="索引设计的依据"></a>索引设计的依据</h2><h3 id="QB-基本问题法"><a href="#QB-基本问题法" class="headerlink" title="QB(基本问题法)"></a>QB(基本问题法)</h3><p>已存在或者计划中的索引是否包含了where子句所有的列(半宽索引)</p>
<h3 id="QUBE-快速上限估算法"><a href="#QUBE-快速上限估算法" class="headerlink" title="QUBE(快速上限估算法)"></a>QUBE(快速上限估算法)</h3><p>通常由以下两个公式确定</p>
<ol>
<li>比较值:LRT=TR * 10ms + TS * 0.01ms</li>
<li>绝对值:LRT=TR * 10ms + TS * 0.01ms + F * 0.1ms</li>
</ol>
<p><em>LRT=本地响应时间</em><br><em>TR=随机访问的数量</em><br><em>TS=顺序访问的数量</em><br><em>F=有效FETCH的数量</em></p>
<h2 id="影响因素"><a href="#影响因素" class="headerlink" title="影响因素"></a>影响因素</h2><h3 id="困难谓词"><a href="#困难谓词" class="headerlink" title="困难谓词"></a>困难谓词</h3><blockquote>
<p>如果一个谓词字段不能参与定义索引片,它无法成为一个匹配谓词,这样对优化器而言太困难了.用户友好型的数据库会提供一个对自己的优化器而言困难谓词列表.(不可索引化)</p>
</blockquote>
<p>除非访问路径是一个多索引扫描,否则只有布尔谓词可以参与定义索引片.</p>
<p>IN谓词可能通过优化变成多个索引片扫描.(oracle的skip range scan)</p>
<p>过滤因子隐患:在以下三个条件同时满足时可能会产生过滤因子隐患</p>
<ol>
<li>访问路径中没有排序</li>
<li>第一屏幕结果一建立就回应.</li>
<li>不是所有的谓词字段都参与定义待扫描的索引片.(不是所有字段都为匹配字段)</li>
</ol>
<h2 id="表连接"><a href="#表连接" class="headerlink" title="表连接"></a>表连接</h2><ol>
<li>嵌套循环<br> 选择可以通过谓词过滤后剩下小部分数据的表当做外层表,并且内层表最好有对应的索引.</li>
<li>合并/hash操作<br> 通过合并扫描出需要连接的表的数据后进行排序或者hash进行连接.</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/05/01/2017-05-01-%E9%9D%9E%E6%9A%B4%E5%8A%9B%E6%B2%9F%E9%80%9A-%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/mountain.jpg">
      <meta itemprop="name" content="wjainng">
      <meta itemprop="description" content="学而不思则罔思而不学则殆">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WJAINNG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/05/01/2017-05-01-%E9%9D%9E%E6%9A%B4%E5%8A%9B%E6%B2%9F%E9%80%9A-%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">非暴力沟通[读书笔记]</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-05-01 11:00:14" itemprop="dateCreated datePublished" datetime="2017-05-01T11:00:14+08:00">2017-05-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-16 23:15:44" itemprop="dateModified" datetime="2020-09-16T23:15:44+08:00">2020-09-16</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>“你取之于我,<br>是我得到的最好的礼物,<br>当你知道我因施与你而快乐.<br>你明白,<br>我的给予不是让你欠我的人情,<br>而是因为我想活出对你的爱.<br>欣然的接受,<br>或许是最佳的赏赐.<br>我无法将二者分开.<br>当你施与我,<br>我给你我的接纳.<br>当你取之于我,<br>我感激你的赐予.”<br> <sub><sub align=right>–鲁思.贝本梅尔唱片集&lt;&lt;获赠&gt;&gt;</sub></sub></p>
</blockquote>
<p>非暴力沟通提醒我们专注于彼此的观察,感受,需要和请求,鼓励倾听,培育尊重与爱,使我们情意相通,乐于互助.</p>
<p>非暴力沟通的四个要素</p>
<ol>
<li>观察</li>
<li>感受</li>
<li>需要</li>
<li>请求</li>
</ol>
<h3 id="是什么蒙蔽了爱"><a href="#是什么蒙蔽了爱" class="headerlink" title="是什么蒙蔽了爱?"></a>是什么蒙蔽了爱?</h3><p>某些语言和表达方式的负面影响,虽然致力于满足某种愿望,却倾向于忽视人的感受和需要,以致彼此的疏远和伤害.</p>
<h4 id="道德评判"><a href="#道德评判" class="headerlink" title="道德评判"></a>道德评判</h4><p>用道德标准来评判人,如果一个人的行为<em>不符合我们的价值观</em>,那他就被看做是不道德和邪恶的.</p>
<blockquote>
<p>“在道德与不道德的区分之外,有片田野.我将在那里见你”<small>–鲁米</small></p>
</blockquote>
<p>然而语言使我们陷于是非之中,它擅长将人分类,把人看做好人,坏人,正常或者不正常,负责任和不负责任,聪明或愚蠢等等.</p>
<p>一心分析和确定错误的性质,而忽视自己和他人的需要,其实完全由自己的需要进行判断.如果女友想多一些体贴,那她就”太黏人了”,如果我想多一些体贴那她”冷漠得像个木头”.</p>
<h4 id="进行比较"><a href="#进行比较" class="headerlink" title="进行比较"></a>进行比较</h4><p>比较蒙蔽了我们对人对己的爱.</p>
<h4 id="回避责任"><a href="#回避责任" class="headerlink" title="回避责任"></a>回避责任</h4><p>我们对自己的思想,情感和行动负有责任.可是,人们广泛使用**”不得不”**这一个短语来淡化个人的责任.</p>
<p>当我们根据以下理由行动时,我们也就试图回避责任:<br><strong>说不清楚的力量驱使</strong></p>
<blockquote>
<p>为什么打扫房间?<br>因为我不得不做.</p>
</blockquote>
<p><strong>我们的个人情况,成长经历,自我形象等</strong></p>
<blockquote>
<p>为什么喝酒?<br>因为我是个酒鬼.</p>
</blockquote>
<p><strong>其他人的行为</strong><br><strong>上级的命令</strong><br><strong>同伴的压力</strong><br><strong>规章制度与政策</strong><br>…</p>
<h4 id="强人所难"><a href="#强人所难" class="headerlink" title="强人所难"></a>强人所难</h4><p>我们对别人的要求往往暗含着威胁:如果不配合,他们就会受到惩罚.这是强者常用的手段.</p>
<h3 id="区分观察与评论"><a href="#区分观察与评论" class="headerlink" title="区分观察与评论"></a>区分观察与评论</h3><blockquote>
<p>不区分观察和评论,人们倾向于听到批评.<br>不带评论的观察是人类智力的最高形式.<sub>印度哲学家克里希那穆</sub></p>
</blockquote>
<p>非暴力沟通的第一个要素是观察,我们仔细观察正在发生的事情,并清楚的说出观察结果.</p>
<blockquote>
<p>“我从未见过懒惰的；<br>我见过有个人有时在下午睡觉，在雨天不出门，但他不是一个懒惰的人。<br>请在你胡言乱语之前，想一想，他是个懒惰的人，还是他的行为被我们称为“懒惰”？<br>我从未见过愚蠢的孩子；<br>我见过有个孩子有时做的事我不理解，或不按我的吩咐做事情，但他不是一个愚蠢的孩子。<br>请在你说他愚蠢之前，想一想，他是个愚蠢的孩子，还是他懂的事情和你不一样？<br>我使劲看了又看，从早到晚从未看到厨师；<br>我看到有个人把食物调配在一起，打起了火，看着炒菜的炉子——我看到这些但没有看到厨师。<br>告诉我，当你看的时候，你看到的是厨师，还是有个人做的事情被我们称为烹饪？<br>我们说有的人懒惰，另一些人说他们与世无争，<br>我们说有的人愚蠢，另一些人说他学习方法有区别。<br>因此，我得出结论，如果不把事实和意见混为一谈，我们将不再困惑。<br>因为你可能无所谓，我也想说：这只是我的意见。<br><sub>——鲁思.贝本梅尔</sub>”</p>
</blockquote>
<ol>
<li>使用的语言没有体现出评论的人对其评论负有责任.</li>
<li>对他人的思想,情感或愿望的推测当做唯一可能.</li>
<li>缺乏依据.</li>
<li>评价他人能力时,把评论当做事实.</li>
<li>使用形容词和副词,把评论当做事实.</li>
</ol>
<p>观察需要清楚的描述观察结果,而不是进行评论.例如:</p>
<blockquote>
<p>“欧文在过去的5场比赛中没有进一个球”,而不是”欧文是个差劲的前锋”<br>“索菲对我没有什么吸引力”,而不是”苏菲长得很丑”<br>“米奇上周五买书花了一千元”,而不是”米奇花钱大手大脚”</p>
</blockquote>
<h3 id="体会和表达感受"><a href="#体会和表达感受" class="headerlink" title="体会和表达感受"></a>体会和表达感受</h3><p>越是留意自己内心的声音,就越能听到别人的声音.</p>
<h4 id="区分感受和想法"><a href="#区分感受和想法" class="headerlink" title="区分感受和想法"></a>区分感受和想法</h4><blockquote>
<p>我觉得我吉他弹得不好.(想法)<br>作为吉他手,我有些失落/郁闷/烦透了.(感受)</p>
</blockquote>
<h4 id="表达感受的词汇表"><a href="#表达感受的词汇表" class="headerlink" title="表达感受的词汇表"></a>表达感受的词汇表</h4><ol>
<li>得到满足时的感受:兴奋,喜悦,甜蜜,精力充沛…</li>
<li>没有得到满足时的感受:害怕,担心,焦虑,着急,紧张…</li>
</ol>
<h3 id="感受的根源"><a href="#感受的根源" class="headerlink" title="感受的根源"></a>感受的根源</h3><p>别人的行为可能会刺激我们,但并不是我们感受的根源,感受的根源在于自身,是我们的需要和期待以及对他人言行的看法,导致了我们的感受.</p>
<blockquote>
<p>“我(感到)…因为我…”的句式来认识感受与自身的关系.</p>
</blockquote>
<p>听到不中听的话的四种选择:</p>
<ol>
<li>责备自己(内疚,惭愧)</li>
<li>指责他人(恼怒)</li>
<li>体会自己的感受和需要(伤心)</li>
<li>体会别人的感受和需要</li>
</ol>
<p>错误的表达方式:</p>
<ol>
<li>只提及相关的事情.</li>
<li>只提及他人的行为.</li>
<li>指责他人.</li>
</ol>
<table>
<thead>
<tr>
<th>错误</th>
<th>正确</th>
</tr>
</thead>
<tbody><tr>
<td>公司海报出现拼写错误使我很生气</td>
<td>看到公司海报出现拼写错误,我很生气,因为我看重公司形象</td>
</tr>
<tr>
<td>你没有把饭吃完,妈妈很生气</td>
<td>你没有把饭吃完,妈妈感到很失望,因为妈妈希望你能健康成长</td>
</tr>
<tr>
<td>你很生气,因为老板说话不算数</td>
<td>老板说话不算话,我很生气,因为我想有一个长假</td>
</tr>
</tbody></table>
<blockquote>
<p>批评往往暗含着期待,对他人的批评实际上间接表达了我们尚未满足的需要.</p>
</blockquote>
<blockquote>
<p>你们现在需要什么?为了满足这些需要,你们希望对方做什么?</p>
</blockquote>
<p>个人成长的三个经历:</p>
<ol>
<li>情感的奴隶.<ul>
<li>让别人快乐是我们的义务,为他人的情绪负责,牺牲自己迎合他人.</li>
</ul>
</li>
<li>面目可憎.<ul>
<li>说出心里话,但是还需要学着尊重他人的需要.</li>
</ul>
</li>
<li>生活的主人.<ul>
<li>这个阶段,我们乐于助人,我们帮助他人,是出于爱,而不是出于恐惧,内疚或惭愧.</li>
</ul>
</li>
</ol>
<h3 id="请求帮助"><a href="#请求帮助" class="headerlink" title="请求帮助"></a>请求帮助</h3><p>需要清楚地告诉对方，我们希望他们做什么，不要请求他人不做什么，因为对方会感到困惑，不知道我们到底想要什么。</p>
<ol>
<li>明确谈话的目的</li>
<li>请求反馈（通过请求反馈确保对方把握我们的意思,对方表达反馈后需要表达感谢）</li>
</ol>
<h4 id="了解他人的反应"><a href="#了解他人的反应" class="headerlink" title="了解他人的反应"></a>了解他人的反应</h4><p>确认对方明白后，我们关心的内容如下：</p>
<ul>
<li>对方此时此刻的感受</li>
<li>对方正在想什么</li>
<li>对方是否接受我们的感受</li>
</ul>
<h4 id="区分请求与命令"><a href="#区分请求与命令" class="headerlink" title="区分请求与命令"></a>区分请求与命令</h4><p>当人们认为不答应我们就会受到惩罚，他们就会把我们的请求当做命令。对命令的两种选择：<strong>服从或反抗</strong>。</p>
<h3 id="倾听"><a href="#倾听" class="headerlink" title="倾听"></a>倾听</h3><p>如果一个人想要别人了解他的处境，听到的却是安慰和建议，他就有可能觉得不太舒服。</p>
<p>放下已有的想法和判断，一心一意地体会他人，体现出与理解和同情之前的区别。</p>
<ol>
<li>体会感受与需要。</li>
<li>给他人反馈。</li>
<li>保持关注。</li>
<li>表达自己的感受。</li>
</ol>
<blockquote>
<p>”你越是留意自己内心的声音，就越能够听到别人的声音“<small>汉马斯克德</small></p>
</blockquote>
<h3 id="爱自己"><a href="#爱自己" class="headerlink" title="爱自己"></a>爱自己</h3><p>许多人陷于自我憎恨中，而无法从失误中获益。（应该，早知道，不得不，这些命令导致我们的生活失去了乐趣）。</p>
<blockquote>
<p>“感到自责是因为我们的行为不符合我们的需要”<br>“人的行为总是服务于自身的需要及价值观”</p>
</blockquote>
<p>用“选择做”代替“不得不”</p>
<p>“我选择做____是因为我想要____。”从而发现自己行为背后的价值取向。</p>
<h3 id="表达愤怒"><a href="#表达愤怒" class="headerlink" title="表达愤怒"></a>表达愤怒</h3><ol>
<li>生气的原因在于我们自己的想法（对他人的评判和指责）</li>
<li>愤怒驱使我们去惩罚他人，而不是满足需要。（忘掉了初心）</li>
<li>体会自己的感受和需要。</li>
<li>体会他人的感受和需要。</li>
</ol>
<h3 id="强制力"><a href="#强制力" class="headerlink" title="强制力"></a>强制力</h3><p>当你不喜欢他的行为时，请问自己两个问题。</p>
<ul>
<li>我希望他怎么做？</li>
<li>我希望他基于什么原因做我希望他做的事情？</li>
</ul>
<blockquote>
<p>强制力是出于防卫（保卫自己或对方）的目的而不是为了惩罚、羞辱或谴责对方。</p>
</blockquote>
<h3 id="表达感激"><a href="#表达感激" class="headerlink" title="表达感激"></a>表达感激</h3><p>赞扬他人时，很少揭示<strong>内心活动</strong>，而把自己放在了<strong>裁判</strong>的位置。</p>
<p>表达感激的要素如下（不自大也不假谦虚）：</p>
<ul>
<li>对我们有益的行为。（观察）</li>
<li>我们的那些需要得到了满足。</li>
<li>需要得到满足后，我们是什么样的心情。</li>
</ul>
<h4 id="接受感激"><a href="#接受感激" class="headerlink" title="接受感激"></a>接受感激</h4><p>别人表达感激时的两种反应：</p>
<ul>
<li>自我膨胀，相信我们比别人优越。</li>
<li>假谦虚。（容易造成反感）</li>
</ul>
<blockquote>
<p>“不要那么谦虚，因为你没有那么伟大”<small>–哥达.梅厄</small></p>
</blockquote>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>观察，感受，需要，请求是沟通的关键，同时沟通时需要牢记自己沟通的目的，不能因为外界因素而忘记了自己的初心。</p>
<p>多从内心找原因，大多数情况下是因为自己的需求得不到满足而导致愤怒，责备他人。</p>
<p>表达请求时需要具体，不能模棱两可，同时寻找反馈以便对方明白自己的需要，对别人的反馈要表达感激。</p>
<p>感激对方时需要具体，最好能说明是哪些点对自己有帮助，如果别人表达感激也要欣然接受。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/10/21/2016-10-21-ShardedJedis%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/mountain.jpg">
      <meta itemprop="name" content="wjainng">
      <meta itemprop="description" content="学而不思则罔思而不学则殆">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WJAINNG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/10/21/2016-10-21-ShardedJedis%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">ShardedJedis分析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-10-21 13:46:41" itemprop="dateCreated datePublished" datetime="2016-10-21T13:46:41+08:00">2016-10-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-16 23:15:44" itemprop="dateModified" datetime="2020-09-16T23:15:44+08:00">2020-09-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>因redis集群需要扩容,想了解下集群扩容后会有多少请求会请求失败,分析了下客户端连接redis的源代码.</p>
<h2 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h2><p>客户端是通过ShardedJedisSentinelPool获取连接进行操作,从构造函数开始看.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ShardedJedisSentinelPool</span><span class="params">(List&lt;String&gt; masters, Set&lt;String&gt; sentinels,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    <span class="keyword">final</span> GenericObjectPoolConfig poolConfig, <span class="keyword">int</span> timeout,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    <span class="keyword">final</span> String password, <span class="keyword">final</span> <span class="keyword">int</span> database)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">this</span>.poolConfig = poolConfig;</span><br><span class="line">   <span class="keyword">this</span>.timeout = timeout;</span><br><span class="line">   <span class="keyword">this</span>.password = password;</span><br><span class="line">   <span class="keyword">this</span>.database = database;</span><br><span class="line">    <span class="comment">//初始化哨兵信息</span></span><br><span class="line">   List&lt;HostAndPort&gt; masterList = initSentinels(sentinels, masters);</span><br><span class="line">   <span class="comment">//初始化连接池</span></span><br><span class="line">   initPool(masterList);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> List&lt;HostAndPort&gt; <span class="title">initSentinels</span><span class="params">(Set&lt;String&gt; sentinels, <span class="keyword">final</span> List&lt;String&gt; masters)</span></span></span><br></pre></td></tr></table></figure>


<p>initSentinels方法通过哨兵和传入的master名字获取到所有master对应的ip和端口号,供后续初始化连接池使用,同时启动线程MasterListener监听哨兵,一旦有主备切换则会重新初始化连接池.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initPool</span><span class="params">(List&lt;HostAndPort&gt; masters)</span> </span>&#123;</span><br><span class="line">   <span class="comment">//MasterListener也会调用该方法</span></span><br><span class="line">   <span class="keyword">if</span> (!equals(currentHostMasters, masters)) &#123;</span><br><span class="line">       StringBuffer sb = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">       <span class="keyword">for</span> (HostAndPort master : masters) &#123;</span><br><span class="line">           sb.append(master.toString());</span><br><span class="line">           sb.append(<span class="string">&quot; &quot;</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       log.info(<span class="string">&quot;Created ShardedJedisPool to master at [&quot;</span> + sb.toString() + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">       List&lt;JedisShardInfo&gt; shardMasters = makeShardInfoList(masters);</span><br><span class="line">       initPool(poolConfig, <span class="keyword">new</span> ShardedJedisFactory(shardMasters, Hashing.MURMUR_HASH, <span class="keyword">null</span>));</span><br><span class="line">       currentHostMasters = masters;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> List&lt;JedisShardInfo&gt; <span class="title">makeShardInfoList</span><span class="params">(List&lt;HostAndPort&gt; masters)</span> </span>&#123;</span><br><span class="line">   List&lt;JedisShardInfo&gt; shardMasters = <span class="keyword">new</span> ArrayList&lt;JedisShardInfo&gt;();</span><br><span class="line">   <span class="keyword">for</span> (HostAndPort master : masters) &#123;</span><br><span class="line">       JedisShardInfo jedisShardInfo = <span class="keyword">new</span> JedisShardInfo(master.getHost(), master.getPort(), timeout);</span><br><span class="line">       jedisShardInfo.setPassword(password);</span><br><span class="line"></span><br><span class="line">       shardMasters.add(jedisShardInfo);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> shardMasters;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>再通过initPool进行连接池初始化,其中通过master组装为JedisShardInfo(name属性没有值,跟后续虚拟节点的hash有关),然后再看ShardedJedisFactory.makeObject,通过此方法创建实际的连接.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> PooledObject&lt;ShardedJedis&gt; <span class="title">makeObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">       ShardedJedis jedis = <span class="keyword">new</span> ShardedJedis(shards, algo, keyTagPattern);</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> DefaultPooledObject&lt;ShardedJedis&gt;(jedis);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>默认的Hash算法为MurmurHash.其中shards为根据之前master对应的信息主要有IP,端口,密码,超时时间等值.</p>
<p>在ShardedJedis的父类Sharded的构造函数中可以看到最后使用了一致性hash并且通过虚拟节点达到当节点出现故障时数据的均衡分布.Sharded.java片段代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//默认权重</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_WEIGHT = <span class="number">1</span>;</span><br><span class="line"><span class="comment">//虚拟节点与真实节点的对应关系</span></span><br><span class="line"><span class="keyword">private</span> TreeMap&lt;Long, S&gt; nodes;</span><br><span class="line"><span class="comment">//Hash算法</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Hashing algo;</span><br><span class="line"><span class="comment">//真实节点与连接的对应关系</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;ShardInfo&lt;R&gt;, R&gt; resources = <span class="keyword">new</span> LinkedHashMap&lt;ShardInfo&lt;R&gt;, R&gt;();</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Sharded</span><span class="params">(List&lt;S&gt; shards, Hashing algo, Pattern tagPattern)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.algo = algo;</span><br><span class="line">    <span class="keyword">this</span>.tagPattern = tagPattern;</span><br><span class="line">    initialize(shards);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(List&lt;S&gt; shards)</span> </span>&#123;</span><br><span class="line">    nodes = <span class="keyword">new</span> TreeMap&lt;Long, S&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i != shards.size(); ++i) &#123;</span><br><span class="line">     <span class="keyword">final</span> S shardInfo = shards.get(i);</span><br><span class="line">     <span class="keyword">if</span> (shardInfo.getName() == <span class="keyword">null</span>) <span class="keyword">for</span> (<span class="keyword">int</span> n = <span class="number">0</span>; n &lt; <span class="number">160</span> * shardInfo.getWeight(); n++) &#123;</span><br><span class="line">       nodes.put(<span class="keyword">this</span>.algo.hash(<span class="string">&quot;SHARD-&quot;</span> + i + <span class="string">&quot;-NODE-&quot;</span> + n), shardInfo);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">else</span> <span class="keyword">for</span> (<span class="keyword">int</span> n = <span class="number">0</span>; n &lt; <span class="number">160</span> * shardInfo.getWeight(); n++) &#123;</span><br><span class="line">       nodes.put(<span class="keyword">this</span>.algo.hash(shardInfo.getName() + <span class="string">&quot;*&quot;</span> + shardInfo.getWeight() + n), shardInfo);</span><br><span class="line">     &#125;</span><br><span class="line">     resources.put(shardInfo, shardInfo.createResource());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>从initialize方法可以看出,默认情况下(权重为1)每一个物理节点(ShardInfo)会产生160个虚拟节点,同时把虚拟节点的hash值和ShardInfo的对应关系存储在nodes中,同时把ShardInfo和redis的连接对应关系存储在resources中.</p>
<blockquote>
<p>**注意:**如果shardInfo没有指定名称,则物理节点是根据master的顺序进行hash的,后续如果新增节点时需要把新的master放入旧master列表的后端,否则会导致节点混乱.(指定名称可以避免此情况)</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> R <span class="title">getShard</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> resources.get(getShardInfo(key));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> S <span class="title">getShardInfo</span><span class="params">(<span class="keyword">byte</span>[] key)</span> </span>&#123;</span><br><span class="line">    SortedMap&lt;Long, S&gt; tail = nodes.tailMap(algo.hash(key));</span><br><span class="line">    <span class="keyword">if</span> (tail.isEmpty()) &#123;</span><br><span class="line">     <span class="keyword">return</span> nodes.get(nodes.firstKey());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> tail.get(tail.firstKey());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上面的代码可以看出,通过key获取连接时,先根据key找到对应的节点(getShardInfo),默认找到比key对应hash值大的第一个节点,如果没找到则返回节点列表中的第一个,然后再获取对应的连接.</p>
<h2 id="一致性Hash"><a href="#一致性Hash" class="headerlink" title="一致性Hash"></a>一致性Hash</h2><p>从上面的Sharded类可以看出使用了一致性hash,顺便复习下一致性hash.</p>
<p>一致性Hash提出了在动态变化的cache环境中,hash算法应该满足下面4个适应条件:</p>
<ol>
<li>均衡性:希望结果尽可能分布到所有的缓存中.</li>
<li>单调性:当有新的缓冲加入系统时,能保证原有分配的内容被映射到原有的或者新的缓存中,而不是旧的其他缓存中.</li>
<li>分散性:在分布式环境中,终端可能看不到所有的缓存,只能看到一部分,可能导致相同的内容被不同的终端映射到不同的缓存区.好的hash算法应该避免不一致的情况发生.</li>
<li>负载:是从另一个角度看待分散性问题,对于一个特定的缓存区可能被不同的用户映射为不同的内容,该情况也应当避免.</li>
</ol>
<p>一般的hash算法是不满足单调性的,当增加或者减少节点时,导致hash值会发生变化.</p>
<h3 id="hash-回环"><a href="#hash-回环" class="headerlink" title="hash 回环"></a>hash 回环</h3><p>hash值都是固定长度的,可以通过一个回环来表示所有的hash值.在一致性hash中,hash值的长度与节点数无关.<br>如下图所示</p>
<h3 id="映射"><a href="#映射" class="headerlink" title="映射"></a>映射</h3><p>hash的目的是把对象映射到对应的缓存中,一致性hash,会把节点和对象分别映射到回环中对应的hash值节点上,然后再顺时针找到大于等于对象hash值对应的节点.</p>
<blockquote>
<p>添加和删除节点时只会影响到比删除或者新增节点的hash值大的下一个节点.</p>
</blockquote>
<h3 id="虚拟节点"><a href="#虚拟节点" class="headerlink" title="虚拟节点"></a>虚拟节点</h3><p>在使用虚拟节点前,虽然可以满足一单调性,但是平衡性不够好,例如删除节点时,之前映射到被删除节点的对象全部映射到了删除节点的下一个节点,另外新增节点时也只会减轻其中一个节点的压力.</p>
<h2 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h2><ol>
<li>增加节点还是对原有的数据有影响,最好是事先算好节点个数,后续通过调整节点的内存大小达到扩容.涉及到节点需要从机器中进行迁移.</li>
<li>ShardedJedisSentinelPool中创建名称时没有使用master的名字而是使用对应master的顺序,因此新增节点时不能修改原有的顺序.(当有一组主备失败时,会启动失败,在运行过程中有一组失败时还是会往对应的节点发送请求?)</li>
<li>考虑分散性虚拟节点最好是按master的名字进行hash.</li>
</ol>
<h2 id="参考列表"><a href="#参考列表" class="headerlink" title="参考列表:"></a>参考列表:</h2><p><a target="_blank" rel="noopener" href="http://baike.baidu.com/link?url=xbnm_MpCnN5pnbCsYrJSeXCUp_RWYF2OFo5iAQvs_M4JYuoSGEBcSjmNdCmhji3XfUX8HU9_SQaZc_cl3Ff5MJiez92uwkrqQ5q3P5Wr7mOr4pcyrIS_7Kts2kVl07wi9TQXhNETwepCQs97dAUE4q">一致性Hash</a><br><a target="_blank" rel="noopener" href="https://github.com/warmbreeze/sharded-jedis-sentinel-pool/blob/master/src/main/java/redis/clients/jedis/ShardedJedisSentinelPool.java">ShardedJedisSentinelPool.java</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/05/03/2016-05-03-GC%E8%B0%83%E4%BC%98%E4%B8%80-%E7%AE%80%E4%BB%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/mountain.jpg">
      <meta itemprop="name" content="wjainng">
      <meta itemprop="description" content="学而不思则罔思而不学则殆">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WJAINNG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/05/03/2016-05-03-GC%E8%B0%83%E4%BC%98%E4%B8%80-%E7%AE%80%E4%BB%8B/" class="post-title-link" itemprop="url">GC调优一[简介]</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-05-03 22:01:46" itemprop="dateCreated datePublished" datetime="2016-05-03T22:01:46+08:00">2016-05-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-16 23:15:44" itemprop="dateModified" datetime="2020-09-16T23:15:44+08:00">2020-09-16</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>gc简介,摘选自java官方文档</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2016/05/03/2016-05-03-GC%E8%B0%83%E4%BC%98%E4%B8%80-%E7%AE%80%E4%BB%8B/">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/05/02/2016-05-02-Java-Finalization/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/mountain.jpg">
      <meta itemprop="name" content="wjainng">
      <meta itemprop="description" content="学而不思则罔思而不学则殆">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WJAINNG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/05/02/2016-05-02-Java-Finalization/" class="post-title-link" itemprop="url">Java Finalization</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-05-02 19:34:18" itemprop="dateCreated datePublished" datetime="2016-05-02T19:34:18+08:00">2016-05-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-16 23:15:44" itemprop="dateModified" datetime="2020-09-16T23:15:44+08:00">2020-09-16</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>对java finalize的理解，摘选自http://www.devx.com/Java/Article/30192</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2016/05/02/2016-05-02-Java-Finalization/">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/04/28/2016-04-28-Java%E5%BC%95%E7%94%A8%E7%B1%BB%E5%9E%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/mountain.jpg">
      <meta itemprop="name" content="wjainng">
      <meta itemprop="description" content="学而不思则罔思而不学则殆">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WJAINNG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/04/28/2016-04-28-Java%E5%BC%95%E7%94%A8%E7%B1%BB%E5%9E%8B/" class="post-title-link" itemprop="url">Java引用类型</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-04-28 23:11:12" itemprop="dateCreated datePublished" datetime="2016-04-28T23:11:12+08:00">2016-04-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-16 23:15:44" itemprop="dateModified" datetime="2020-09-16T23:15:44+08:00">2020-09-16</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Java 引用类型种类说明，以及各类型对GC的影响.</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2016/04/28/2016-04-28-Java%E5%BC%95%E7%94%A8%E7%B1%BB%E5%9E%8B/">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/04/28/2016-04-28-JVM%E7%AC%94%E8%AE%B0%E4%BA%8C-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E5%99%A8%E4%B8%8E%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E7%AD%96%E7%95%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/mountain.jpg">
      <meta itemprop="name" content="wjainng">
      <meta itemprop="description" content="学而不思则罔思而不学则殆">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WJAINNG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/04/28/2016-04-28-JVM%E7%AC%94%E8%AE%B0%E4%BA%8C-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E5%99%A8%E4%B8%8E%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E7%AD%96%E7%95%A5/" class="post-title-link" itemprop="url">JVM笔记二[垃圾收集器与内存分配策略]</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-04-28 22:06:55" itemprop="dateCreated datePublished" datetime="2016-04-28T22:06:55+08:00">2016-04-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-16 23:15:44" itemprop="dateModified" datetime="2020-09-16T23:15:44+08:00">2020-09-16</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="垃圾收集器与内存分配策略"><a href="#垃圾收集器与内存分配策略" class="headerlink" title="垃圾收集器与内存分配策略"></a>垃圾收集器与内存分配策略</h1><h2 id="GC概述"><a href="#GC概述" class="headerlink" title="GC概述"></a>GC概述</h2><p>GC需要完成的3件事情。</p>
<ul>
<li>哪些内存需要回收？(回收对象,what)</li>
<li>什么时候回收？(回收时间,when)</li>
<li>如何回收？(回收方法,how)</li>
</ul>
<p>程序计数器，虚拟机栈，本地方法栈区域中的内容随线程而生，随线程而灭，因此不需要考虑回收的问题。Java堆和方法区则不一样，只有程序运行时才知道会创建哪些对象，这部分内存的分配和回收都是动态的，是垃圾收集器所关注的部分。</p>
<h2 id="对象能够被回收的条件"><a href="#对象能够被回收的条件" class="headerlink" title="对象能够被回收的条件"></a>对象能够被回收的条件</h2><p>垃圾收集器在堆进行回收前，需要确定这些对象是否还被使用。</p>
<h3 id="引用计数法"><a href="#引用计数法" class="headerlink" title="引用计数法"></a>引用计数法</h3><p>给对象添加一个引用计数器，每当有一个地方引用则加一，当引用失效则减一，当引用计数为0时，表示可以回收。<em>缺点是不能解决对象相互循环引用的问题</em><br>例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CircularReference</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ObjB objB = <span class="keyword">new</span> ObjB();</span><br><span class="line">        ObjA objA = <span class="keyword">new</span> ObjA(objB);</span><br><span class="line">        objB.setObjA(objA);</span><br><span class="line"></span><br><span class="line">        objA = <span class="keyword">null</span>;</span><br><span class="line">        objB = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ObjA</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ObjB objB = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ObjA</span><span class="params">(ObjB objB)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.objB = objB;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ObjB</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ObjA objA = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setObjA</span><span class="params">(ObjA objA)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.objA = objA;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<h3 id="对象可达性分析算法"><a href="#对象可达性分析算法" class="headerlink" title="对象可达性分析算法"></a>对象可达性分析算法</h3><p>Java使用可达性分析(Reachability Analysis)来判定对象是否存活。通过一系列的“GC Roots”对象作为起始点，从这些节点开始搜索，搜索所走过的路径称为引用链(Reference Chain),当一个对象到GC Roots没有任何引用链相连则该对象是不可用的。</p>
<p>java语言中可以作为GC Root的对象如下：</p>
<ol>
<li>虚拟机栈中引用的对象(栈帧中的本地变量表)。</li>
<li>方法区中类静态属性引用的对象。</li>
<li>方法区中常量引用的对象。</li>
<li>本地方法栈中引用的对象(Native方法)。</li>
</ol>
<h3 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h3><p>JDK1.2之后，java堆引用的概念进行了扩充，有下面四种引用。</p>
<ol>
<li>强引用。(Strong Reference)</li>
<li>软引用。(Soft Reference)</li>
<li>弱引用。(Weak Reference)</li>
<li>虚引用。(Phantom Reference)<br>引用强调依次逐渐减弱。<br>参考<a href="/2016/04/28/Java%E5%BC%95%E7%94%A8%E7%B1%BB%E5%9E%8B/">Java 引用类型</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/04/25/2016-04-25-JVM%E7%AC%94%E8%AE%B0%E4%B8%80-%E8%87%AA%E5%8A%A8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/mountain.jpg">
      <meta itemprop="name" content="wjainng">
      <meta itemprop="description" content="学而不思则罔思而不学则殆">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WJAINNG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/04/25/2016-04-25-JVM%E7%AC%94%E8%AE%B0%E4%B8%80-%E8%87%AA%E5%8A%A8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" class="post-title-link" itemprop="url">JVM笔记一[自动内存管理]</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-04-25 22:26:42" itemprop="dateCreated datePublished" datetime="2016-04-25T22:26:42+08:00">2016-04-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-16 23:15:44" itemprop="dateModified" datetime="2020-09-16T23:15:44+08:00">2020-09-16</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Java内存区域与内存异常"><a href="#Java内存区域与内存异常" class="headerlink" title="Java内存区域与内存异常"></a>Java内存区域与内存异常</h1><h2 id="运行时数据区"><a href="#运行时数据区" class="headerlink" title="运行时数据区"></a>运行时数据区</h2><ol>
<li>方法区(Method Area)</li>
<li>堆(Heap)</li>
<li>虚拟机栈(VM Stack)</li>
<li>本地方法栈(Native Method Stack)</li>
<li>程序计数器(Program Counter Register)</li>
</ol>
<p><em>其中方法区和堆是有所有线程共享的数据区</em></p>
<h3 id="程序计数器"><a href="#程序计数器" class="headerlink" title="程序计数器"></a>程序计数器</h3><p>程序计数器可以当做为当前线程所执行的字节码的行号指示器，每一个线程有一个独立的程序计数器，各线程之间计数器互不影响，独立存储。该区域为JVM中唯一没有规定任何OutOfMemoryError情况的数据区。</p>
<h3 id="Java虚拟机栈"><a href="#Java虚拟机栈" class="headerlink" title="Java虚拟机栈"></a>Java虚拟机栈</h3><p>Java虚拟机栈为线程私有，其生命周期与线程一样。描述的为java方法执行的内存模型。<br>如果线程请求的栈深度大于虚拟机所允许的深度，会抛出StackOverflowError异常，如果虚拟机栈可以动态扩展但是无法申请到足够的内存，会抛出OutOfMemoryError异常。</p>
<blockquote>
<p>可以通过-Xss128k设置每一个线程的堆栈大小,JDK5.0之后默认为1M.该值越少在同等物理内存下可以生成更多的线程,同时操作系统对一个进程内的线程数也有限制.(jvm本身的内存大小,系统的限制)</p>
</blockquote>
<h3 id="本地方法栈"><a href="#本地方法栈" class="headerlink" title="本地方法栈"></a>本地方法栈</h3><p>本地方法栈与java虚拟机栈的作用相似，只是虚拟机栈为执行java方法服务，而本地方法栈为虚拟机用到的Native方法服务。JVM的实现可以把本地方法栈与虚拟机栈合二为一例如HotSpot。本地方法栈也会抛出StackOverflowError和OutOfMemoryError异常。</p>
<h3 id="Java堆"><a href="#Java堆" class="headerlink" title="Java堆"></a>Java堆</h3><p>java堆是被所有内存共享的一块内存区域，在jvm启动时创建。所有的对象实例和数组都是在堆上分配。内存的分配和回收设计的内容很多，例如TLAB（Thread Local Allocation Buffer）为了加快分配的速度可以给每一个线程一个私有的分配缓冲区，为了更好的进行垃圾回收，堆会细分为新生代，老年代等。如果内存不够会抛出OutOfMemoryError异常。虚拟机是否使用TLAB可以通过-XX:+/-UseTLAB参数设定。</p>
<blockquote>
<p>可以通过-Xms，-Xmx进行设置堆内存的大小, -Xmn设置新生代的大小,-XX:NewRatio=4表示新生代和老年代的比例为1:4,新生代占堆大小的1/5.-XX:SurvivorRatio=8表示新生代中Eden与Survivor区的大小比值,因为有两个Suvivor区因此Eden占整个新生代的8/10.<br>-XX:+PrintTenuringDistribution可以显示每次Minor GC时Survivor区各个年龄的对象的大小.<br>-XX:InitialTenuringThreshol和-XX:MaxTenuringThreshold可以设置晋升到老年代的对象的年龄的最小值和最大值.每一次Minor GC后,年龄就加1.</p>
</blockquote>
<h3 id="方法区"><a href="#方法区" class="headerlink" title="方法区"></a>方法区</h3><p>方法区为各个线程共享的内存区域，存储被虚拟机加载的类信息，常量，静态变量，即时编译后的代码等。可以通过-XX:MaxPermSize进行设置，JDK8中已经没有永久区的概念，变成了元空间（Metaspace）。会抛出OutOfMemoryError异常。</p>
<blockquote>
<p>-XX:MetaspaceSize=N设置Metaspace的初始大小.<br>-XX:MaxMetaspaceSize=N设置Metaspace的最大值.<br>-XX:MinMetaspaceFreeRatio=N当Metaspace的空闲空间小于这个比例时会导致Metaspace增加.<br>-XX:MaxMetaspaceFreeRatio=N当Metaspace的空闲空间大于这个比例时会导致Metaspace减少.<br>-XX:MaxMetaspaceExpansion=N设置Metaspace增长的最大幅度.<br>-XX:MinMetaspaceExpansion=N设置Metaspace增长时的最小幅度.</p>
</blockquote>
<h4 id="运行时常量池"><a href="#运行时常量池" class="headerlink" title="运行时常量池"></a>运行时常量池</h4><p>运行时常量池(Runtime Constant Pool)为方法区的一部分，用于存放编译期生成的各种字面量和符号引用。运行期间也可能将新的常量放入池中，例如String的intern方法。会抛出OutOfMemory异常。</p>
<h3 id="直接内存"><a href="#直接内存" class="headerlink" title="直接内存"></a><em>直接内存</em></h3><p>直接内存(Direct Memory)不是虚拟机运行时数据区的一部分，也不是虚拟机规范中定义的内存区域。NIO中可以使用Native函数直接分配堆外内存，通过DirectByteBuffer作为这块内存的引用进行操作。</p>
<h2 id="虚拟机对象探秘"><a href="#虚拟机对象探秘" class="headerlink" title=" 虚拟机对象探秘"></a> 虚拟机对象探秘</h2><h3 id="对象的创建"><a href="#对象的创建" class="headerlink" title="对象的创建"></a>对象的创建</h3><p>为对象分配空间的任务等同于把一块确定大小的内存从java堆中划分出来。如果java堆中内存是规整的，用过的内存在一边，没用过的在另一边，分配内存时只需要把指针向空闲空间移动对应大小的距离即可，这种分配方式称为指针碰撞(Bump the Pointer).如果空闲的内存不是规整的则需要记录下空闲的地址，并且从一块够大的空间中划分给对象实例，并更新列表中的记录，这种方式称为空闲列表(Free List).java堆是否规整由所采用的垃圾收集器是否有压缩整理功能决定。</p>
<h3 id="对象的内存布局"><a href="#对象的内存布局" class="headerlink" title="对象的内存布局"></a>对象的内存布局</h3><p>对象在内存中存储的布局可以分为3块区域：对象头(Header),实例数据(Instance Data),对齐填充(Padding).</p>
<p><strong>对象头包含两部分：</strong></p>
<ol>
<li>存储对象自身的运行时数据，例如HashCode，GC分代年龄，锁状态标志，线程持有的锁等。(32位虚拟机和64位虚拟机中分别占32bit和64bit[未开启压缩指针])，Mark Word.</li>
<li>类型指针，对象指向它的类元数据的指针，虚拟机用来确定对象是哪个类的实例。如果对象为数组，还需要一个记录数组长度的数据。</li>
</ol>
<p><strong>实例数据</strong><br>实例数据为对象真正存储的有效信息，为程序代码中所定义的各种类型的字段内容。(包括从父类继承和子类定义的)。存储顺序受虚拟机分配策略参数(FieldsAllocationStyle)和java源代码中定义的顺序影响。HotSport默认的策略为从大到小，相同宽度的字段分配在一起。<br><strong>对齐填充</strong><br>HotSpot VM的自动内存管理系统要求对象起始地址必须是8字节的整数倍，当实例数据没有对齐时，需要通过对齐来补充。(对象头部分恰好是8字节的倍数，1或者2)。</p>
<h3 id="对象的访问"><a href="#对象的访问" class="headerlink" title="对象的访问"></a>对象的访问</h3><p>程序通过栈上的reference来操作堆上的具体对象，具体的访问方式由JVM实现决定。主流的方式有使用句柄和直接指针两种。</p>
<p><strong>句柄访问</strong><br>java堆中划分一块内存当做句柄池，reference中存储的为对象的句柄地址，句柄中包含了对象实例数据与类型数据对应的具体地址信息。<br><img src="/images/pointer.png" alt="alter 命中"><br><em>优点：</em>reference中存储的是稳定的句柄地址，对象被移动时只会改变句柄中的实例数据指针，reference本身不需要修改。<br><em>缺点：</em>速度不够快，需要两次指针访问才能访问到对象。</p>
<p><strong>直接访问</strong><br>如果使用直接指针访问，则java对象中需要考虑如何存放类型数据的相关信息，reference中存储的为对象的地址。<br><img src="/images/direct.png" alt="alter 命中"><br><em>优点：</em>访问速度快与句柄访问相比节省了一次指针访问。<br><em>缺点：</em>对象移动时需要修改reference，指针不稳定。</p>
<blockquote>
<p>因对象访问在java中非常频繁，HotSport中使用直接访问方式。</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="http://www.oracle.com/technetwork/java/whitepaper-135217.html#memory">jvm架构白皮书</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/01/01/2016-01-01-%E8%AF%BB%E4%B9%A6%E6%B8%85%E5%8D%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/mountain.jpg">
      <meta itemprop="name" content="wjainng">
      <meta itemprop="description" content="学而不思则罔思而不学则殆">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WJAINNG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/01/01/2016-01-01-%E8%AF%BB%E4%B9%A6%E6%B8%85%E5%8D%95/" class="post-title-link" itemprop="url">读书清单</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-01-01 18:37:18" itemprop="dateCreated datePublished" datetime="2016-01-01T18:37:18+08:00">2016-01-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-16 23:15:44" itemprop="dateModified" datetime="2020-09-16T23:15:44+08:00">2020-09-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AE%A1%E5%88%92/" itemprop="url" rel="index"><span itemprop="name">计划</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li><input disabled="" type="checkbox"> scala</li>
</ul>
<p>2016年读书列表</p>
<ul>
<li><p>时间管理等</p>
<ul>
<li><input checked="" disabled="" type="checkbox"> 高效能人士的7个习惯</li>
</ul>
</li>
<li><p>编程语言类</p>
<ul>
<li><input disabled="" type="checkbox"> scala</li>
<li><input disabled="" type="checkbox"> java</li>
<li><input disabled="" type="checkbox"> oracle</li>
</ul>
</li>
</ul>
<ul>
<li>软件技能<ul>
<li><input disabled="" type="checkbox"> 程序员的思维修炼</li>
<li><input disabled="" type="checkbox"> 修改代码的艺术</li>
<li><input checked="" disabled="" type="checkbox"> 计算机程序的构造和解释</li>
<li><input disabled="" type="checkbox"> 深入理解计算机系统</li>
<li><input disabled="" type="checkbox"> Building Microservices</li>
<li><input disabled="" type="checkbox"> 实现模式</li>
<li><input disabled="" type="checkbox"> 设计模式</li>
<li><input checked="" disabled="" type="checkbox"> UNIX编程艺术</li>
</ul>
</li>
</ul>
<ul>
<li><p>敏捷</p>
<ul>
<li><input disabled="" type="checkbox"> 看板方法</li>
<li><input disabled="" type="checkbox"> 持续交付</li>
<li><input disabled="" type="checkbox"> 用户故事与敏捷方法</li>
<li>[-] 硝烟中的Scrum和XP</li>
<li><input disabled="" type="checkbox"> 实现领域驱动设计</li>
<li>[-] 精益和敏捷开发大型应用指南</li>
<li>[-] 分析模式</li>
<li>[-] 解析极限编程</li>
</ul>
</li>
<li><p>工具</p>
<ul>
<li><input disabled="" type="checkbox"> 管理3.0</li>
<li><input disabled="" type="checkbox"> 第5项修炼</li>
<li><input disabled="" type="checkbox"> 系统思考</li>
<li><input disabled="" type="checkbox"> 金字塔原理</li>
<li><input disabled="" type="checkbox"> 程序员的职业素养</li>
<li><input disabled="" type="checkbox"> 编写可读代码的艺术</li>
<li><input disabled="" type="checkbox"> 重构</li>
<li><input disabled="" type="checkbox"> 敏捷软件开发</li>
<li><input disabled="" type="checkbox"> 白帽子讲Web安全</li>
<li><input disabled="" type="checkbox"> maven</li>
<li><input disabled="" type="checkbox"> git</li>
<li><input disabled="" type="checkbox"> 精益创业</li>
<li><input disabled="" type="checkbox"> 丰田人才精益模式</li>
<li><input disabled="" type="checkbox"> 精益思想</li>
<li><input disabled="" type="checkbox"> 实例化需求:团队如何交付正确的软件</li>
</ul>
</li>
<li><p>心理学</p>
<ul>
<li><input disabled="" type="checkbox"> 影响力</li>
<li><input disabled="" type="checkbox"> 部落-一呼百应的力量</li>
</ul>
</li>
<li><p>大数据</p>
<ul>
<li><input disabled="" type="checkbox"> Apache Kafka</li>
<li><input disabled="" type="checkbox"> Zookeeper</li>
<li><input disabled="" type="checkbox"> Hbase in action</li>
<li><input disabled="" type="checkbox"> Hadoop 权威指南</li>
</ul>
</li>
<li><p>其它</p>
<ul>
<li><input disabled="" type="checkbox"> 咨询的奥义</li>
<li><input disabled="" type="checkbox"> 咨询的奥义续集</li>
<li><input disabled="" type="checkbox"> 系统之美</li>
<li><input disabled="" type="checkbox"> 系统化思维导论</li>
<li><input disabled="" type="checkbox"> 系统思考</li>
<li><input disabled="" type="checkbox"> 实现模式</li>
<li><input disabled="" type="checkbox"> 闭环式管理，系统性思维</li>
</ul>
</li>
</ul>
<ul>
<li><p><input disabled="" type="checkbox">  a task list item</p>
</li>
<li><p><input disabled="" type="checkbox">  list syntax required</p>
</li>
<li><p><input disabled="" type="checkbox">  normal <strong>formatting</strong>, @mentions, #1234 refs</p>
</li>
<li><p><input disabled="" type="checkbox">  incomplete</p>
</li>
<li><p><input checked="" disabled="" type="checkbox">  completed</p>
<p><input type='checkbox' checked disabled>  aaa</input></p>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2015/12/26/2015-12-26-%E9%A2%86%E5%9F%9F%E9%A9%B1%E5%8A%A8%E8%AE%BE%E8%AE%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/mountain.jpg">
      <meta itemprop="name" content="wjainng">
      <meta itemprop="description" content="学而不思则罔思而不学则殆">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WJAINNG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2015/12/26/2015-12-26-%E9%A2%86%E5%9F%9F%E9%A9%B1%E5%8A%A8%E8%AE%BE%E8%AE%A1/" class="post-title-link" itemprop="url">领域驱动设计</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2015-12-26 18:11:08" itemprop="dateCreated datePublished" datetime="2015-12-26T18:11:08+08:00">2015-12-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-16 23:15:44" itemprop="dateModified" datetime="2020-09-16T23:15:44+08:00">2020-09-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/DDD/" itemprop="url" rel="index"><span itemprop="name">DDD</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="让领域模型发挥作用"><a href="#让领域模型发挥作用" class="headerlink" title="让领域模型发挥作用"></a>让领域模型发挥作用</h2><h3 id="前提："><a href="#前提：" class="headerlink" title="前提："></a>前提：</h3><ol>
<li>大多数软件项目中，主要焦点应该是领域与领域逻辑。</li>
<li>复杂的领域设计应该基于模型。</li>
</ol>
<h3 id="开发实践："><a href="#开发实践：" class="headerlink" title="开发实践："></a>开发实践：</h3><ol>
<li>迭代开发。</li>
<li>开发人员与领域专家具有密切的关系。</li>
</ol>
<p>模型是一种知识形式，对知识进行有选择的简化和有目的的结构化，适当的模型可以使人理解信息的意义，并专注于问题相关的信息。（是一个解决信息超载问题的工具）</p>
<h3 id="模型在领域驱动设计中的作用"><a href="#模型在领域驱动设计中的作用" class="headerlink" title="模型在领域驱动设计中的作用"></a>模型在领域驱动设计中的作用</h3><ol>
<li>模型和设计的核心互相影响。</li>
</ol>
<p><em>模型与实现之间的紧密联系才使得模型变得有用，并确保在模型中进行的分析能够转换为最终产品，可以基于对模型的理解来解释代码</em></p>
<ol start="2">
<li>模型是团队所有成员所使用的交流语言的中枢。</li>
</ol>
<p><em>模型与实现之间是紧密结合的，可以将模型作为一种沟通语言与领域专家进行沟通</em></p>
<ol start="3">
<li>模型是浓缩的知识。</li>
</ol>
<p><em>模型是团队一致认同的领域知识组织方式和最重要元素的区分方式，模型体现了思考方式，共同语言使得开发人员与领域专家在将信息组织为模型时更有效的协作</em></p>
<h3 id="软件的核心"><a href="#软件的核心" class="headerlink" title="软件的核心"></a>软件的核心</h3><p><strong>软件的核心是其为用户解决领域相关问题的能力</strong>，其他特性，不管多么重要，都要服务于这个基本目的。</p>
<h2 id="消化知识"><a href="#消化知识" class="headerlink" title="消化知识"></a>消化知识</h2><p>可以通过<strong>对象交互的场景</strong>，进行模型验证，每当有新的功能需求时就在原来的模型上进行验证，如果不能满足则修改原有模型对象，并理解这些模型中新增的知识，在精化模型的过程中，代码也一步步演进。</p>
<h3 id="有效建模的要素"><a href="#有效建模的要素" class="headerlink" title="有效建模的要素"></a>有效建模的要素</h3><ol>
<li>模型与实现的绑定。</li>
</ol>
<p><em>最初的原型虽然简单，但是建立了实现之间的链接，在后续的迭代中一直维护该原型</em></p>
<ol start="2">
<li>获得了一种基于模型的语言。</li>
</ol>
<p><em>通过不断的根据模型进行沟通，研发人员与领域专家慢慢地能够直接使用模型中的术语，并将他们组织为符合模型结构的语句</em></p>
<ol start="3">
<li>开发一个蕴含丰富知识的模型。</li>
</ol>
<p><em>对象具有行为和强制性规则，模型包含各种类型的知识</em></p>
<ol start="4">
<li>提炼模型。</li>
</ol>
<p><em>在模型完善的过程中，重要的概念不断被添加到模型中，同时不再使用或不重要的概念则从模型中删除，当一个不需要的概念与一个需要的概念有关联时，可以把需要的概念提取到一个新模型中，不需要的概念则可以删除</em></p>
<ol start="5">
<li>头脑风暴和实验。</li>
</ol>
<p><em>通过走场景，进行模型的验证，通过头脑风暴的创造力和实验对模型进行提炼，把团队的知识转化为有价值的模型</em></p>
<h3 id="知识消化"><a href="#知识消化" class="headerlink" title="知识消化"></a>知识消化</h3><p>信息的资料来源于领域专家头脑中的知识，来自现有系统的用户，也来自技术团队以前在相关遗留系统或同领域的其他项目中积累的经验。</p>
<p>传统的瀑布方式，知识的流动是单向的，分析员得不到程序员与前期系统上线的反馈。只有领域专家，分析员与程序员将自己的知识输入到模型中，模型的组织才更严密，抽象也更加整洁，为实现提供更大的支持。因为领域专家也参与其中，确保模型是对业务原理的真正抽象。</p>
<h3 id="持续学习"><a href="#持续学习" class="headerlink" title="持续学习"></a>持续学习</h3><p>项目都会丢失知识,已经学到了一些知识的人可能干别的事情去了,团队可能重组了.</p>
<p>高效率的团队需要有意识地积累知识，并持续学习。对开发人员来说既要完善技术知识，也要增强领域建模技巧。（学习从事工作的特定领域知识）</p>
<h3 id="知识丰富的设计"><a href="#知识丰富的设计" class="headerlink" title="知识丰富的设计"></a>知识丰富的设计</h3><p>领域模型和相应的设计可用来保护和共享知识。更加明确的设计具有以下优点：</p>
<ol>
<li>为了实现更明确的设计，程序员与其他相关人员都能理解领域的知识。明白是一个业务规则而不是一个计算问题。</li>
<li>程序员可以向业务专家展示技术工件，甚至代码，但必须是领域专家可以理解的，以便形成反馈。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">makeBooking</span><span class="params">(Cargo cargo, Voyage voyage)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">double</span> maxBooking = voyage.capacity() * <span class="number">1.1</span>;</span><br><span class="line">    <span class="keyword">if</span> ((voyage.bookedCargoSize() + cargo.size()) &gt; maxBooking) &#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> confirmation = orderConfirmationSequence.next();</span><br><span class="line">    voyage.addCargo(cargo, confirmation);</span><br><span class="line">    <span class="keyword">return</span> confirmation;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>例如上面的超订问题,应该把业务规则移到领域建模中,而不是通过一句代码把业务规则隐藏掉了.</p>
</blockquote>
<h3 id="深层模型"><a href="#深层模型" class="headerlink" title="深层模型"></a>深层模型</h3><p>随着对领域和应用程序需求的理解逐步加深，往往会丢弃最初看起来很重要的表面元素，一开始不可能发现的巧妙抽象就会渐渐浮出水面。</p>
<h2 id="语言的交流和使用"><a href="#语言的交流和使用" class="headerlink" title="语言的交流和使用"></a>语言的交流和使用</h2><p>领域模型是软件项目的公共语言的核心，模型是人们头脑中形成的与项目有关的概念集合。提供了模型语言的语义，且十分精确，以便支持开发。将模型与开发活动结合在一起，使模型与代码紧密绑定。</p>
<p>翻译使得沟通不畅，并导致知识消化变得困难。</p>
<p>通用语言的词汇表包括类名称和主要操作，团队一致应用于领域模型的模式名称来使这种语言更为丰富。</p>
<p>一个团队，一种语言。</p>
<p>领域专家能够更深入地思考他们所从事的领域，如果经验丰富的领域专家都不能理解模型，则模型一定是有问题的。</p>
<p>开发人员通过和领域专家一步一步地使用模型对象来走查场景，从而对模型进行非正式的测试。通过这个过程，可以互相加深理解，并对概念进行精化。</p>
<h2 id="绑定模型和实现"><a href="#绑定模型和实现" class="headerlink" title="绑定模型和实现"></a>绑定模型和实现</h2><h3 id="模式"><a href="#模式" class="headerlink" title="模式"></a>模式</h3><p>严格按照基础模型来编写代码，能够使代码更好地表达设计含义，并且使模型更符合设计。</p>
<p>模型驱动设计不再将分析模型与程序设计分离，而是寻求一种能够满足这两方面需求的单一模型。</p>
<p>从模型中获取用于程序设计和基本任务分配的术语，程序代码就是模型的表达，修改代码就是改变模型，而模型的改变势必会影响到接下来相应的项目活动。</p>
<h2 id="模型驱动设计的构造块"><a href="#模型驱动设计的构造块" class="headerlink" title="模型驱动设计的构造块"></a>模型驱动设计的构造块</h2><h3 id="分离领域"><a href="#分离领域" class="headerlink" title="分离领域"></a>分离领域</h3><p>在软件中，专门用于解决领域问题的那部分通常只占整个软件系统的很小一部分，与其重要性不成比例。需要将领域对象与系统中的其他功能分离，避免将领域概念和其他只与软件技术相关的概念相混淆，也不会把领域与整个软件系统混为一谈。</p>
<h4 id="模式-分层架构"><a href="#模式-分层架构" class="headerlink" title="模式:分层架构"></a>模式:分层架构</h4><p>如果领域有关的代码分散在大量的其他代码中，则查看和分析领域代码就会变得相当困难。（用户界面的修改有可能改变业务逻辑，调整业务也可能要修改界面）</p>
<p>要想创建能够处理复杂任务的程序，需要把不同的关注点分开考虑，</p>
<p>给复杂的应用程序划分层次。在每一层内分别进行设计，使其具有内聚性并且只依赖于它的下层。采用标准的架构模式，只与上层进行松散连接。将与领域模型相关的代码放在一个层中，领域对象应该将重点放在如何表达领域模型上，而不要考虑显示和存储等问题。</p>
<h4 id="模型属于领域层"><a href="#模型属于领域层" class="headerlink" title="模型属于领域层"></a>模型属于领域层</h4><p>领域层是领域模型以及所有与其直接相关的设计元素的表现。由业务逻辑的设计和实现组成。如果领域逻辑与程序中的其他关注点混在一起，就不能实现这种一致性，将领域实现独立出来是领域驱动设计的前提。</p>
<h4 id="模式-智能用户界面"><a href="#模式-智能用户界面" class="headerlink" title="模式:智能用户界面"></a>模式:智能用户界面</h4><p>在用户界面中实现所有的业务逻辑。（领域驱动设计只有在大型项目中才能产生最大的收益，并且项目团队能掌握那些技巧）</p>
<p>SMART UI模式的优点：</p>
<ul>
<li>效率高，短时间内实现<em>简单</em>的应用程序。</li>
<li>对开发人员的要求较低。</li>
<li>可以克服分析上的不足，把原型发布给用户，根据用户反馈快速修改产品即可。</li>
<li>程序之间彼此独立，可以相对准确地安排小模块交付的日期。扩展简单功能也很容易。</li>
<li>很顺利地使用关系数据库。</li>
</ul>
<p>缺点：</p>
<ul>
<li>不通过数据库很难集成应用模块。</li>
<li>没有对行为的重用，也没对业务问题的抽象。</li>
<li>复杂的功能很快会让你无所适从。</li>
</ul>
<h3 id="软件中所表示的模型"><a href="#软件中所表示的模型" class="headerlink" title="软件中所表示的模型"></a>软件中所表示的模型</h3><h4 id="关联"><a href="#关联" class="headerlink" title="关联"></a>关联</h4><p>对象之间的关联使得建模与实现之间的交互更为复杂。</p>
<p>有三种方式可以使得关联更易于控制。</p>
<ol>
<li>规定一个遍历方向。</li>
<li>添加限定符，以便有效地减少多重关联。</li>
<li>消除不必要的关联。</li>
</ol>
<p>简化和约束模型的关联是通往MODEL-DRIVEN-DESIGN的必经之路。仔细区分对象可以使得模型更加清晰，并得到更实用的实现。</p>
<h4 id="模式-ENTITY-REFERENCE-OBJECT"><a href="#模式-ENTITY-REFERENCE-OBJECT" class="headerlink" title="模式:ENTITY(REFERENCE OBJECT)"></a>模式:ENTITY(REFERENCE OBJECT)</h4><p>很多对象不是通过他们的属性定义的，而是通过一连串的连续事件和标识定义的。</p>
<p>主要由标识定义的对象成为ENTITY（实体），有特殊的建模和设计思路。它们具有生命周期，这期间它们的形式和内容可能发生根本改变，但是其标识保持不变。</p>
<p>只要满足两个条件就可以为ENTITY。</p>
<ol>
<li>在整个生命周期中具有连续性。</li>
<li>对用户来说非常重要的不同状态不是由属性决定的。</li>
</ol>
<h5 id="ENTITY建模"><a href="#ENTITY建模" class="headerlink" title="ENTITY建模"></a>ENTITY建模</h5><p>ENTITY的最基本职责是确保联系性，以便使其行为更清楚且可预测。不需要将注意力集中在属性或行为上，而应该抓住ENTITY对象定义的最基本特征，尤其是那些用于识别，查找或匹配对象的特征。</p>
<h5 id="设计标识操作"><a href="#设计标识操作" class="headerlink" title="设计标识操作"></a>设计标识操作</h5><p>每个ENTITY都必须有一种建立标识的操作方式，以便与其他对象区分开，即使这些对象与它具有相同的描述属性。（类似数据库中的key）不管系统如何定义，都必须确保标识属性在系统中是唯一的。</p>
<h4 id="模式：VALUE-OBJECT"><a href="#模式：VALUE-OBJECT" class="headerlink" title="模式：VALUE OBJECT"></a>模式：VALUE OBJECT</h4><p>用于描述领域的某个方面而本身没有标识的对象称为VALUE OBJECT（值对象）。VALUE OBJECT被实例化之后用来表示一些设计元素，只关心这些元素是什么，而不关心它们是谁。</p>
<p>当我们只关心一个模型元素的属性时，应该把它归类为VALUE OBJECT。应该使这个模型元素能够表示出其属性的意义，并为它提供相关功能。VALUE OBJECT应该是不可变的，不要给它分配任何标识，也不要把它设计成ENTITY那么复杂。</p>
<h5 id="设计VALUE-OBJECT"><a href="#设计VALUE-OBJECT" class="headerlink" title="设计VALUE OBJECT"></a>设计VALUE OBJECT</h5><p>我们并不关心使用的是VALUE OBJECT的哪个实例。在设计VALUE OBJECT时有多种选择，包括复制，共享或保持VALUE OBJECT不变。为了安全地共享一个对象，必须确保共享对象是不变的，否则会影响所有对其有引用的对象的属性。(可以通过传递不变对象或者对象的一个副本进行解决)。</p>
<p>复制和共享哪个更划算取决于实现环境，复制可能导致系统被大量的对象阻塞，但共享可能会减慢分布式系统的速度。<br>下面的情况最好使用共享，可以发挥共享的最大价值并最大限度地减少麻烦：</p>
<ul>
<li>当节省数据库空间或者减少对象数量是一个关键要求时。（内存有限的情况下）</li>
<li>当通信开销很低时。（例如在中央服务器中）</li>
<li>当共享的对象被严格限定为不可变时。</li>
</ul>
<h5 id="设计包含VALUE-OBJECT的关联"><a href="#设计包含VALUE-OBJECT的关联" class="headerlink" title="设计包含VALUE OBJECT的关联"></a>设计包含VALUE OBJECT的关联</h5><p>模型中的关联越少越好，越简单越好。应该完全清除VALUE OBJECT之间的双向关联，如果模型中确实需要这种关联，应该重新考虑下将对象声明为VALUE OBJECT这个决定是否正确。</p>
<h4 id="模式：SERVICE"><a href="#模式：SERVICE" class="headerlink" title="模式：SERVICE"></a>模式：SERVICE</h4><p>在某些情况下，最实用的设计会包含一些特殊的操作，这些操作从概念上讲不属于任何对象，会在模型中引入一种新的元素，这就是SERVICE（服务）。</p>
<p>SERVICE是作为接口提供的一种操作，它在模型中是独立的，不像ENTITY和VALUE OBJECT那样具有封装的状态。它强调的是与其他对象的关系与ENTITY与VALUE OBJECT不同，只是定义了能够为客户做什么。SERVICE是以一个活动命名，而不是以一个ENTITY命名，是一个动词而非名词。其参数与结果应该是领域对象。</p>
<p>好的SERVICE有以下3个特征：</p>
<ol>
<li>与领域概念相关的操作不是ENTITY或VALUE OBJECT的一个自然部分。</li>
<li>接口是根据领域模型的其他元素定义的。</li>
<li>操作是无状态的。（指任何客户都可以使用某个SERVICE的任何实例，不必关系该实例的历史状态）</li>
</ol>
<p>当领域中的某个重要的过程或者转换操作不属于实体或者值对象的自然职责时，应该在模型中添加一个作为独立接口的操作，并将其声明为SERVICE。定义接口时要使用模型语言，此外应该将SERVICE定义为无状态的。</p>
<h5 id="SERVICE与孤立的领域层"><a href="#SERVICE与孤立的领域层" class="headerlink" title="SERVICE与孤立的领域层"></a>SERVICE与孤立的领域层</h5><p>SERVICE并不止在领域层中使用，需要区分属于领域层的SERVICE和那些属于其他层的SERVICE，并划分责任，以便将它们明确地区分开。</p>
<p>文献中对SERVICE的讨论大多是单纯从技术角度讨论，属于基础设施层。领域层和应用层的SERVICE与这些基础设施层SERVICE进行协作。例如封装了电子邮件系统的接口，就是基础设施层中的一个SERVICE。</p>
<p>应用层SERVICE和领域层SERVICE可能很难区分。应用层负责安排一个通知，而领域层负责确定是否满足临界值，将SERVICE划分到各个曾中：</p>
<ul>
<li>应用层：资金转账应用服务<ul>
<li>获取输入</li>
<li>发送消息给领域层服务，要求其执行</li>
<li>监听确认消息</li>
<li>决定使用基础设施SERVICE来发送通知</li>
</ul>
</li>
<li>领域层：资金转账领域服务<ul>
<li>与必要的账户和总账对象进行交互，执行相应的借入和贷出操作</li>
<li>提供结果的确认（允许转账或拒绝转账等）</li>
</ul>
</li>
<li>基础设施层：发送通知服务<ul>
<li>按照应用程序的指示发送电子邮件，信件和其他信息</li>
</ul>
</li>
</ul>
<h4 id="模式：MODULE（PACKAGE"><a href="#模式：MODULE（PACKAGE" class="headerlink" title="模式：MODULE（PACKAGE)"></a>模式：MODULE（PACKAGE)</h4><p>MODULE为人们提供两种观察模型的方式，一是可以在MODULE中查看细节，而不会被整个模型淹没，二是观察MODULE之间的关系，而不考虑其内部细节。领域层中的MODULE是模型中有意义的部分，从更大的角度描述了领域。</p>
<p>MODULE之间应该是低耦合的，而在MODULE的内部则是高内聚的。MODULE不仅仅是代码的划分，而且也是概念的划分，一个人一次考虑的事情是有限的（因此才需要低耦合），不连贯的思想和一锅粥似的思维同样难于理解（因此才需要高内聚）。</p>
<p>如果模型讲述了一个故事，那么MODULE就是整个故事中的各个章节。模块的名称表达了其意义。</p>
<h5 id="敏捷的MODULE"><a href="#敏捷的MODULE" class="headerlink" title="敏捷的MODULE"></a>敏捷的MODULE</h5><p>MODULE需要与模型的其他部分一同演变。更改MODULE可能需要大范围地更新代码，因此MODULE结构和名称往往反映了模型的较早形式，而类则不是这样的。</p>
<h5 id="基础设施驱动的打包存在隐患"><a href="#基础设施驱动的打包存在隐患" class="headerlink" title="基础设施驱动的打包存在隐患"></a>基础设施驱动的打包存在隐患</h5><p>除非真正有必要将代码分布到不同的服务器上，否则就把实现单一概念对象的所有代码放在同一个模块中（如果不能放在同一个对象中的话）实现业务逻辑的对象与负责数据库访问的对象之间的联系非常广泛，因此他们之间的耦合度很高。</p>
<h3 id="建模范式"><a href="#建模范式" class="headerlink" title="建模范式"></a>建模范式</h3><p>主流的范式是面向对象设计</p>
<h4 id="在混合范式中坚持使用MODEL-DRIVEN-DESIGN"><a href="#在混合范式中坚持使用MODEL-DRIVEN-DESIGN" class="headerlink" title="在混合范式中坚持使用MODEL-DRIVEN DESIGN"></a>在混合范式中坚持使用MODEL-DRIVEN DESIGN</h4><p>在面向对象的应用中，有时会混合使用一些其他技术，例如规则引擎。当将非对象元素混合到以面向对象为主的系统中时，需要遵循以下4条经验规则</p>
<ol>
<li>不要和实现规范对抗。</li>
<li>把通用语言作为依靠的基础。</li>
<li>不要一味依赖UML。</li>
<li>保持怀疑态度。</li>
</ol>
<h2 id="领域对象的生命周期"><a href="#领域对象的生命周期" class="headerlink" title="领域对象的生命周期"></a>领域对象的生命周期</h2><p>使用FACTORY（工厂）来创建和重建复杂对象，并使用AGGREGATE来封装它们的内部结构。最后在生命周期的中间和末尾使用REPOSITORy（存储库）来提供查找和检索持久对象并封装庞大基础设施的手段。</p>
<h3 id="模式：AGGREGATE"><a href="#模式：AGGREGATE" class="headerlink" title="模式：AGGREGATE"></a>模式：AGGREGATE</h3><p>将关联减至最少的设计有助于简化对象之间的遍历，并在某种程度上限制关系的急剧增多。但大多数业务领域中的对象都具有十分复杂的联系，以至于最终形成一个很长很深的对象引用路径，在某种程度上，这种混乱状态反映了现实世界，因为现实世界中就很少有清晰的边界。</p>
<p>AGGREGATE划分出一个范围，在这个范围内，生命周期的每个阶段都必须满足一些固定规则。</p>
<h3 id="模式：FACTORY"><a href="#模式：FACTORY" class="headerlink" title="模式：FACTORY"></a>模式：FACTORY</h3><p>当创建一个对象或创建整个AGGREGATE时，如果创建工作很复杂，或者暴露了过多的内部结构，可以使用FACTORY进行封装。</p>
<p>对象的创建本身可以是一个主要操作，但被创建的对象并不适合承担复杂的装配操作。将这些职责混合在一起可能导致出现难以理解的设计。复杂的对象创建是领域层的职责，然而这项任务并不属于那些用于表示模型的对象。FACTORY应该封装创建一个复杂对象或AGGREGATE所属的知识，它提供一个反映客户目标的接口，以及一个被创建对象的抽象视图。</p>
<p>应该将创建复杂对象的实例和聚合的职责转移给一个单独的对象，这个对象本身在领域模型中可能没有职责，但它仍是领域设计的一部分。提供一个封装所有复杂装配操作的接口，并且不需要客户引用要被实例化的对象的具体类 。在创建AGGREGATE时要把它作为一个整体，并确保它满足固定规则。</p>
<p>FACTORY有很多中设计方法：FACTORY METHOD（工厂方法），ABSTRACT FACTORY（抽象工厂）和BUILDER（构建器）。任何好的工厂都需要满足以下两个基本需求。</p>
<ol>
<li>每个创建方法都是原子方法，而且满足被创建对象或AGGREGSTE的所有固定规则。</li>
<li>FACTORY应该被抽象为所需的类型，而不是创建出具体的类。</li>
</ol>
<h4 id="选择FACTORY及其应用位置"><a href="#选择FACTORY及其应用位置" class="headerlink" title="选择FACTORY及其应用位置"></a>选择FACTORY及其应用位置</h4><p>FACTORY的作用是使创建出的对象将细节隐藏起来，因此我们把FACTORY用在那些需要隐藏细节的地方。通常与AGGREGATE有关。</p>
<p>当有些细节需要隐藏（无论要隐藏的是具体实现还是构造的复杂性）而又找不到一个自然的地方来隐藏它们时，必须创建一个专用的FACTORY对象或SERVICE。整个AGGREGATE通常由一个独立的FACTORY来创建，FACTORY负责把对根的引用传递出去，并确保创建出的AGGREGATE满足固定规则。</p>
<h4 id="有些时候只需要使用构造函数"><a href="#有些时候只需要使用构造函数" class="headerlink" title="有些时候只需要使用构造函数"></a>有些时候只需要使用构造函数</h4><p>在以下情况下最好使用简单的，公共的构造函数：</p>
<ul>
<li>类是一种类型。不是任何相关层次结构的一部分，而且没有通过接口实现多态。</li>
<li>客户关心的是实现，可能是将其作为选择STRATEGY的一种方式。</li>
<li>客户可以访问对象的所有属性。</li>
<li>构造并不复杂。</li>
<li>公共构造函数必须遵守与FACTORY相同的规则：必须是一个原子操作，并且满足被创建对象的所有固定规则。</li>
</ul>
<h4 id="接口的设计"><a href="#接口的设计" class="headerlink" title="接口的设计"></a>接口的设计</h4><p>当设计FACTORY的方法签名时需要注意下面的两点：</p>
<ol>
<li>每个操作都必须是原子的。</li>
<li>FACTORY将与其参数发生耦合。</li>
</ol>
<blockquote>
<p>使用抽象类型的参数，而不是它们的具体类，降低耦合。</p>
</blockquote>
<h4 id="固定规则的逻辑应放置在哪里"><a href="#固定规则的逻辑应放置在哪里" class="headerlink" title="固定规则的逻辑应放置在哪里"></a>固定规则的逻辑应放置在哪里</h4><p>FACTORY负责确保它所创建的对象或AGGREGATE满足所有固定规则，然而在把应用于一个对象的规则移到该对象外部之前应该三思，FACTORY可以将固定规则检查工作委派给产品，这通常是最佳选择。</p>
<h4 id="ENTITY-FACTORY与VALUE-OBJECT-FACTORY"><a href="#ENTITY-FACTORY与VALUE-OBJECT-FACTORY" class="headerlink" title="ENTITY FACTORY与VALUE OBJECT FACTORY"></a>ENTITY FACTORY与VALUE OBJECT FACTORY</h4><p>VALUE OBJECT 是不可变的，所以完成产品就是最终形式，因此FACTORY必须提供产品的完整描述。而ENTITY FACTORY则只需具有构造有效AGGREGATE所需的那些属性。</p>
<h4 id="重建已存储的对象"><a href="#重建已存储的对象" class="headerlink" title="重建已存储的对象"></a>重建已存储的对象</h4><p>重建对象的factory与创建对象的factory很类似，主要有以下两个不同点：</p>
<ol>
<li>用于重建对象的factory不分配新的id，如果重新分配id将与先前的对象id发生冲突。因此id必须是输入参数的一部分。</li>
<li>当规定规则未被满足时，重建对象的factory采用不同的处理方式。如果创建新对象时未满足可以简单地拒绝创建对象，但是如果为重建，则需要有更灵活的处理，需要通过一些策略来修复这种不一致的情况（例如对象存在数据库中）。</li>
</ol>
<h3 id="模式：REPOSITORY"><a href="#模式：REPOSITORY" class="headerlink" title="模式：REPOSITORY"></a>模式：REPOSITORY</h3><ul>
<li>为客户提供一个简单的模型，可用来获取持久对象并管理它们的生命周期。</li>
<li>使应用程序和领域设计与持久化技术解耦。</li>
<li>体现了有关对象访问的设计决策。</li>
<li>很容易替换为哑实现，在测试中使用。</li>
</ul>
<h4 id="REPOSITORY的查询"><a href="#REPOSITORY的查询" class="headerlink" title="REPOSITORY的查询"></a>REPOSITORY的查询</h4><p>可以构建硬编码式的查询，因为即使它们不做这些事，一些客户也必须要做。在一些需要执行大量查询的项目上，可以构建一个支持更灵活的查询的REPOSITORY框架，例如基于SPECIFICATION的查询特别适合作为一个框架来使用。</p>
<h4 id="客户代码可以忽略REPOSITORY的实现，但开发人员不能忽略"><a href="#客户代码可以忽略REPOSITORY的实现，但开发人员不能忽略" class="headerlink" title="客户代码可以忽略REPOSITORY的实现，但开发人员不能忽略"></a>客户代码可以忽略REPOSITORY的实现，但开发人员不能忽略</h4><p>持久化技术的封装可以使得客户变得十分简单，并且使客户与REPOSITORY的实现之间完全解耦，但像一般的封装一样，开发人员必须知道在封装背后的内涵。在使用REPOSITORY时，不同的使用方式或工作方式可能会对性能产生极大的影响。</p>
<h4 id="REPOSITORY的实现"><a href="#REPOSITORY的实现" class="headerlink" title="REPOSITORY的实现"></a>REPOSITORY的实现</h4><ul>
<li>对类型进行抽象</li>
<li>充分利用repository与客户解耦的优点(方便测试)</li>
<li>将事务控制权留给客户</li>
</ul>
<h4 id="REPOSITORY与FACTORY的关系"><a href="#REPOSITORY与FACTORY的关系" class="headerlink" title="REPOSITORY与FACTORY的关系"></a>REPOSITORY与FACTORY的关系</h4><p>FACTORY负责处理对象生命周期的开始,而REPOSITORY帮助管理生命周期的中间和结束.</p>
<p>FACTORY负责创建新的对象,而REPOSITORY负责查找已经存在的对象.</p>
<h2 id="突破"><a href="#突破" class="headerlink" title="突破"></a>突破</h2><h3 id="机遇"><a href="#机遇" class="headerlink" title="机遇"></a>机遇</h3><blockquote>
<p>与大部分重构相比,突破的回报更多,风险也更高,并且突破出现的时机可能很不合时宜.<br>过渡到深层模型需要从根本上调整思路,并且对设计做大幅修改</p>
</blockquote>
<h3 id="关注根本"><a href="#关注根本" class="headerlink" title="关注根本"></a>关注根本</h3><p>Wjainng@321</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="wjainng"
      src="/images/mountain.jpg">
  <p class="site-author-name" itemprop="name">wjainng</p>
  <div class="site-description" itemprop="description">学而不思则罔思而不学则殆</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">56</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">wjainng</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

  

</body>
</html>
